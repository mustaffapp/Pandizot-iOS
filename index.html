<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
    <title>3S Sound Pro</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="speaker_icon.png?v=2">
    <link rel="manifest" href="manifest.json">
    
    <style>
        @font-face {
            font-family: 'myFont';
            src: url('zaptron.otf') format('opentype'),
                 url('zaptron.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
            font-display: swap; 
        }

        * { box-sizing: border-box; }
        :root { --theme: #007aff; --bg: #000000; --card: #1c1c1e; --text: #ffffff; --sub: #98989d; --border: #333333; --active-green: #34c759; }
        
        body { margin: 0; background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; display: flex; justify-content: center; height: 100vh; overflow: hidden; }
        #app { width: 100%; max-width: 440px; background: var(--bg); position: relative; display: flex; flex-direction: column; height: 100%; overflow: hidden; }

        .page { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 100; overflow-y: auto; padding-bottom: 20px; }
        .page.active { display: block; }
        
        .header { padding: 40px 24px 20px; display: flex; justify-content: space-between; align-items: center; }
        
        h1 { font-family: 'myFont', sans-serif; font-size: 26px; font-weight: normal; margin: 0; text-transform: uppercase; }
        h1 span { color: #ff3b30; }
        
        .icon-btn { width: 47px; height: 47px; border-radius: 50%; background: var(--card); border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .icon-btn img { width: 27.5px; height: 27.5px; object-fit: contain; }

        .status-container { padding: 0 24px 10px; }
        .status-pill { display: inline-flex; align-items: center; background: var(--card); color: var(--sub); padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: 700; border: 1px solid var(--border); }
        .status-pill.connected { color: var(--theme); border-color: var(--theme); background: rgba(0, 122, 255, 0.15); }
        .status-pill::before { content: "●"; margin-right: 8px; font-size: 10px; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; padding: 10px 24px; }
        .box { background: var(--card); border-radius: 28px; padding: 24px; aspect-ratio: 1 / 1.1; display: flex; flex-direction: column; justify-content: space-between; border: 2px solid transparent; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
        .box.active { border-color: var(--theme); box-shadow: 0 0 15px rgba(0, 122, 255, 0.1); }
        
        .box-top { display: flex; justify-content: space-between; align-items: center; }
        .device-icon { width: 47.5px; height: 47.5px; object-fit: contain; opacity: 0.8; }
        .box.active .device-icon { opacity: 1; filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); }

        .toggle-switch { position: relative; width: 50px; height: 30px; background: #3a3a3c; border-radius: 15px; transition: 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 26px; height: 26px; background: white; border-radius: 50%; transition: 0.3s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        
        .box.active .toggle-switch { background: var(--theme); }
        .box.active .toggle-switch::after { transform: translateX(20px); }

        .box-info { display: flex; flex-direction: column; gap: 4px; }
        .box-title { font-weight: 700; font-size: 18px; color: var(--text); }
        .box-status { font-size: 11px; color: var(--sub); font-weight: 800; text-transform: uppercase; }
        .box.active .box-status { color: var(--theme); }

        .reconnect-area { padding: 20px 24px 30px; margin-top: auto; }
        .main-btn { width: 100%; background: var(--theme); color: white; padding: 18px; border-radius: 16px; font-weight: 700; text-align: center; cursor: pointer; font-size: 16px; box-shadow: 0 4px 15px rgba(0, 122, 255, 0.3); }
        .main-btn.secondary { background: var(--card); border: 1px solid var(--border); color: var(--text); box-shadow: none; }

        .page-header { padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); background: var(--bg); position: sticky; top: 0; z-index: 10; height: 70px; }
        .header-btn { color: var(--theme); font-size: 16px; cursor: pointer; font-weight: 600; }
        
        .settings-group { margin: 20px 24px; }
        .group-label { color: var(--sub); font-size: 12px; margin-bottom: 8px; font-weight: 700; text-transform: uppercase; }
        .settings-card { background: var(--card); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; }
        .settings-row { display: flex; padding: 14px 18px; border-bottom: 1px solid var(--border); justify-content: space-between; align-items: center; color: var(--text); }
        .settings-row:last-child { border-bottom: none; }

        .val-grid { display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid var(--border); }
        .val-cell { padding: 12px 18px; border-right: 1px solid var(--border); }
        .val-cell:last-child { border-right: none; }
        input { background: none; border: none; color: var(--text); font-size: 16px; width: 100%; text-align: right; outline: none; }

        .color-palette { display: flex; gap: 10px; flex-wrap: wrap; justify-content: flex-end; max-width: 60%; }
        .color-dot { width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-dot.selected { border-color: var(--text); transform: scale(1.15); }
    </style>
</head>
<body>
    <div id="app">
        <div id="dashboard" class="page active" style="display:flex; flex-direction:column;">
            <div class="header">
                <div class="icon-btn" onclick="openPage('settings')"><img src="settings_icon.png?v=2" alt="S"></div>
                <h1><span>3S</span> Sound</h1>
                <div class="icon-btn" onclick="openPage('bluetooth')"><img src="bluetooth_icon.png?v=2" alt="B"></div>
            </div>
            <div class="status-container"><div id="mainStatus" class="status-pill">Bağlı Değil</div></div>
            <div class="grid" id="mainGrid"></div>
            <div class="reconnect-area"><div class="main-btn secondary" onclick="reconnectLastDevice()">Tekrar Bağlan ↻</div></div>
        </div>

        <div id="settings" class="page">
            <div class="page-header"><span class="header-btn" onclick="openPage('dashboard')">‹ Geri</span><span style="font-weight:700">Ayarlar</span><span style="width:40px"></span></div>
            <div id="settingsList"></div>
            <div class="settings-group">
                <div class="group-label">Görünüm</div>
                <div class="settings-card">
                    <div class="settings-row" style="align-items: flex-start;">
                        <span>Tema</span>
                        <div class="color-palette" id="themePalette"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="bluetooth" class="page">
            <div class="page-header"><span class="header-btn" onclick="openPage('dashboard')">‹ Geri</span><span style="font-weight:700">Bluetooth</span><span style="width:40px"></span></div>
            <div id="deviceList" style="padding:24px;"></div>
            <div style="padding:24px;"><button class="main-btn" onclick="startScan()">Cihaz Ara</button></div>
        </div>
    </div>

    <script>
        const SERVICE_UUID = "0000ffe0-0000-1000-8000-00805f9b34fb";
        const CHAR_UUID = "0000ffe1-0000-1000-8000-00805f9b34fb";
        const colors = ["#007aff", "#34c759", "#ff3b30", "#af52de", "#ff9500", "#5856d6"];
        let bleCharacteristic;
        
        const labels = ["Pandizot", "LED", "Sistem"];
        let config = JSON.parse(localStorage.getItem('3s_config_v2')) || [
            {id:0, name:"Anahtar 1", on:"1", off:"2", state:false, icon:"speaker_icon.png?v=2"},
            {id:1, name:"Anahtar 2", on:"3", off:"4", state:false, icon:"light_icon.png?v=2"},
            {id:2, name:"Anahtar 3", on:"5", off:"6", state:false, icon:"system_icon.png?v=2"}
        ];

        function openPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        function render() {
            const grid = document.getElementById('mainGrid');
            grid.innerHTML = config.map(s => `
                <div class="box ${s.state ? 'active' : ''}" onclick="toggleSwitch(${s.id})">
                    <div class="box-top"><img src="${s.icon}" class="device-icon"><div class="toggle-switch"></div></div>
                    <div class="box-info"><div class="box-title">${s.name}</div><div class="box-status">${s.state ? 'AÇIK' : 'KAPALI'}</div></div>
                </div>
            `).join('');

            const sList = document.getElementById('settingsList');
            sList.innerHTML = config.map((s, i) => `
                <div class="settings-group">
                    <div class="group-label">${labels[i]}</div>
                    <div class="settings-card">
                        <div class="settings-row"><span>Buton İsmi</span><input type="text" value="${s.name}" oninput="updateConfig(${i},'name',this.value)"></div>
                        <div class="val-grid">
                            <div class="val-cell"><div style="font-size:9px;color:var(--sub)">AÇIK KOMUTU</div><input type="text" value="${s.on}" oninput="updateConfig(${i},'on',this.value)"></div>
                            <div class="val-cell"><div style="font-size:9px;color:var(--sub)">KAPALI KOMUTU</div><input type="text" value="${s.off}" oninput="updateConfig(${i},'off',this.value)"></div>
                        </div>
                    </div>
                </div>
            `).join('');

            const cur = localStorage.getItem('theme') || colors[0];
            const palette = document.getElementById('themePalette');
            if(palette) {
                palette.innerHTML = colors.map(c => `
                    <div class="color-dot ${c === cur ? 'selected' : ''}" style="background:${c}" onclick="applyTheme('${c}')"></div>
                `).join('');
            }
        }

        function applyTheme(c) {
            localStorage.setItem('theme', c);
            document.documentElement.style.setProperty('--theme', c);
            document.documentElement.style.setProperty('--active-green', c === '#ff3b30' ? '#ff3b30' : '#34c759');
            render();
        }

        function updateConfig(id, key, val) { config[id][key] = val; save(); if(key === 'name') render(); }
        function save() { localStorage.setItem('3s_config_v2', JSON.stringify(config)); }

        async function toggleSwitch(id) {
            config[id].state = !config[id].state;
            render(); save();
            if(bleCharacteristic) {
                const val = config[id].state ? config[id].on : config[id].off;
                await bleCharacteristic.writeValue(new TextEncoder().encode(val));
            }
        }

        async function startScan() {
            const device = await navigator.bluetooth.requestDevice({ filters: [{ services: [SERVICE_UUID] }] });
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            bleCharacteristic = await service.getCharacteristic(CHAR_UUID);
            document.getElementById('mainStatus').innerText = "Bağlı: " + device.name;
            openPage('dashboard');
        }

        applyTheme(localStorage.getItem('theme') || colors[0]);
        render();
    </script>
</body>
</html>
