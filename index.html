<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
    <title>3S Sound Pro</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="speaker_icon.png">
    <link rel="manifest" href="manifest.json">
    
    <style>
        @font-face {
            font-family: 'myFont';
            src: url('myFont.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
        }

        * { box-sizing: border-box; }
        :root { 
            --theme: #007aff; 
            --bg: #000000;    
            --card: #1c1c1e;  
            --text: #ffffff;  
            --sub: #98989d;   
            --border: #333333;
        }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            color: var(--text); 
            font-family: -apple-system, sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            display: flex; 
            justify-content: center; 
            height: 100vh; 
            overflow: hidden; 
        }

        #app { width: 100%; max-width: 440px; background: var(--bg); position: relative; display: flex; flex-direction: column; height: 100%; overflow: hidden; }

        .page { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg); z-index: 100; overflow-y: auto; padding-bottom: 20px; }
        .page.active { display: block; }
        
        .header { padding: 40px 24px 20px; display: flex; justify-content: space-between; align-items: center; height: 90px; }
        h1 { font-family: 'myFont'; font-size: 26px; font-weight: normal; margin: 0; text-transform: uppercase; }
        h1 span { color: #ff3b30; }

        .page-header { padding: 40px 24px 20px; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; height: 90px; }
        .title-text { font-weight: 700; font-size: 18px; text-align: center; }
        
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 18px; padding: 10px 24px; }
        .box { background: var(--card); border-radius: 28px; padding: 24px; aspect-ratio: 1 / 0.95; display: flex; flex-direction: column; justify-content: space-between; border: 2px solid transparent; cursor: pointer; transition: 0.2s; }
        .box.active { border-color: var(--theme); }
        
        /* Bekleme modunda butonların görsel tepkisi */
        .box.waiting { opacity: 0.6; cursor: not-allowed; }

        .box-top { display: flex; flex-direction: row; justify-content: space-between; align-items: center; }
        .device-icon { width: 60px; height: 60px; object-fit: contain; }
        .box-info { display: flex; flex-direction: column; align-items: flex-start; }
        .box-status{ font-size: 10px; margin-top: 5%; }
        
        .toggle-switch { position: relative; width: 50px; height: 30px; background: #3a3a3c; border-radius: 15px; transition: 0.3s; }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 26px; height: 26px; background: white; border-radius: 50%; transition: 0.3s; }
        .box.active .toggle-switch { background: var(--theme); }
        .box.active .toggle-switch::after { transform: translateX(20px); }

        .settings-group { margin: 20px 24px; }
        .group-label { color: var(--sub); font-size: 10px; margin-bottom: 8px; font-weight: 700; text-transform: uppercase; }
        .settings-card { background: var(--card); border-radius: 16px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 12px; }
        .settings-row { display: flex; padding: 14px 18px; border-bottom: 1px solid var(--border); justify-content: space-between; align-items: center; background: rgba(255, 255, 255, 0.03); }
        
        .val-grid { display: grid; grid-template-columns: 1fr 1fr; border-top: 1px solid var(--border); background: rgba(0, 0, 0, 0.1); }
        .val-cell { padding: 12px 18px; border-right: 2px solid var(--border); }
        
        input { background: none; border: none; color: var(--text); font-size: 16px; width: 100%; text-align: right; outline: none; }
        .color-dot { width: 26px; height: 26px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-dot.selected { border-color: var(--text); transform: scale(1.1); }

        .bt-connect-btn { background: var(--theme); color: white; border: none; padding: 16px 32px; border-radius: 16px; font-size: 16px; font-weight: 700; width: 100%; cursor: pointer; }
        .icon-btn { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: none; background: transparent; }
        .icon-btn img { width: 30px; height: 30px; object-fit: contain; }
    </style>
</head>
<body>
    <div id="app">
        <div id="dashboard" class="page active">
            <div class="header">
                <div class="icon-btn" onclick="openPage('settings')"><img src="settings_icon.png"></div>
                <h1><span>3S</span> Sound</h1>
                <div class="icon-btn" onclick="openPage('bluetooth')"><img src="bluetooth_icon.png"></div>
            </div>
            <div class="grid" id="mainGrid"></div>
        </div>

        <div id="settings" class="page">
            <div class="page-header">
                <span style="color:var(--theme); cursor:pointer;" onclick="render();openPage('dashboard')">‹ Geri</span>
                <span class="title-text">Ayarlar</span>
                <span></span>
            </div>
            <div id="settingsList" class="settings-group"></div>
            <div class="settings-group">
                <div class="group-label">GÖRÜNÜM</div>
                <div class="settings-card">
                    <div class="settings-row">
                        <span>Tema</span>
                        <div style="display:flex; gap:10px;" id="themePalette"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="bluetooth" class="page">
            <div class="page-header">
                <span style="color:var(--theme); cursor:pointer;" onclick="render();openPage('dashboard')">‹ Geri</span>
                <span class="title-text">Bluetooth</span>
                <span></span>
            </div>
            <div style="padding:40px 24px;">
                <button class="bt-connect-btn" onclick="connectBluetooth()">Cihaza Bağlan</button>
                <div id="statusText" style="margin-top:24px; color:var(--sub); font-size:14px; text-align: center;">Bağlantı Yok</div>
            </div>
        </div>
    </div>

    <script>
        const colors = ["#007aff", "#34c759", "#ff3b30", "#af52de", "#ff9500", "#5856d6"];
        let config = JSON.parse(localStorage.getItem('3s_config_v2')) || [
            {id:0, name:"Pandizot", on:"1", off:"2", state:false, icon:"speaker_icon.png"},
            {id:1, name:"LED", on:"3", off:"4", state:false, icon:"light_icon.png"},
            {id:2, name:"Sistem", on:"5", off:"6", state:false, icon:"system_icon.png"}
        ];

        let bleCharacteristic = null;
        let isWaiting = false;

        const MY_SERVICE = "91bad492-b950-4226-aa2b-4ede9fa42f59";
        const MY_CHAR = "cba1d466-344c-4be3-ab31-107015375cdd";
        const STD_SERVICE = "0000ffe0-0000-1000-8000-00805f9b34fb";
        const STD_CHAR = "0000ffe1-0000-1000-8000-00805f9b34fb";

        function openPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        async function connectBluetooth() {
            const status = document.getElementById('statusText');
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: [MY_SERVICE, STD_SERVICE]
                });
                const server = await device.gatt.connect();
                let service, characteristic;
                try {
                    service = await server.getPrimaryService(MY_SERVICE);
                    characteristic = await service.getCharacteristic(MY_CHAR);
                } catch (e) {
                    service = await server.getPrimaryService(STD_SERVICE);
                    characteristic = await service.getCharacteristic(STD_CHAR);
                }
                bleCharacteristic = characteristic;
                status.innerText = "Bağlandı: " + device.name;
                status.style.color = "var(--theme)";
            } catch (error) { status.innerText = "Bağlantı Hatası"; }
        }

        async function sendBTData(data) {
            if (!bleCharacteristic) return;
            try {
                const encoder = new TextEncoder();
                await bleCharacteristic.writeValue(encoder.encode(data));
            } catch (error) { bleCharacteristic = null; }
        }

        function render() {
            const grid = document.getElementById('mainGrid');
            grid.innerHTML = config.map(s => `
                <div class="box ${s.state ? 'active' : ''} ${isWaiting ? 'waiting' : ''}" onclick="toggleSwitch(${s.id})">
                    <div class="box-top">
                        <img src="${s.icon}" class="device-icon">
                        <div class="toggle-switch"></div>
                    </div>
                    <div class="box-info">
                        <div class="box-title">${s.name}</div>
                        <div class="box-status">${s.state ? 'AÇIK' : 'KAPALI'}</div>
                    </div>
                </div>
            `).join('');

            const sList = document.getElementById('settingsList');
            sList.innerHTML = `<div class="group-label">FONKSİYON</div>` + config.map((s, i) => `
                <div class="settings-card">
                    <div class="settings-row"><span>${s.name}</span><input type="text" value="${s.name}" oninput="updateConfig(${i},'name',this.value)"></div>
                    <div class="val-grid">
                        <div class="val-cell"><div style="font-size:9px;color:var(--sub)">AÇIK</div><input type="text" value="${s.on}" oninput="updateConfig(${i},'on',this.value)"></div>
                        <div class="val-cell"><div style="font-size:9px;color:var(--sub)">KAPALI</div><input type="text" value="${s.off}" oninput="updateConfig(${i},'off',this.value)"></div>
                    </div>
                </div>
            `).join('');

            const cur = localStorage.getItem('theme') || colors[0];
            const palette = document.getElementById('themePalette');
            palette.innerHTML = colors.map(c => `<div class="color-dot ${c === cur ? 'selected' : ''}" style="background:${c}" onclick="applyTheme('${c}')"></div>`).join('');
        }

        function updateConfig(id, key, val) { 
            config[id][key] = val; 
            localStorage.setItem('3s_config_v2', JSON.stringify(config)); 
        }

        function applyTheme(c) {
            localStorage.setItem('theme', c);
            document.documentElement.style.setProperty('--theme', c);
            render();
        }

        function toggleSwitch(id) { 
            if (isWaiting) return;

            config[id].state = !config[id].state;

            if (id === 2) { 
                isWaiting = true;
                if (config[2].state) {
                    config[0].state = true;
                    config[1].state = true;
                    sendBTData(config[2].on);
                    setTimeout(() => sendBTData(config[0].on), 100);
                    setTimeout(() => sendBTData(config[1].on), 1700); 
                } else {
                    config[0].state = false;
                    config[1].state = false;
                    sendBTData(config[2].off); 
                    setTimeout(() => sendBTData(config[0].off), 100); 
                    setTimeout(() => sendBTData(config[1].off), 1700); 
                }
                setTimeout(() => { isWaiting = false; render(); }, 2000);
            } else {
                if ((id === 0 || id === 1) && !config[id].state) {
                    config[2].state = false;
                    sendBTData(config[2].off);
                }
                const code = config[id].state ? config[id].on : config[id].off;
                sendBTData(code);
                
                if (id === 0) { 
                    isWaiting = true;
                    setTimeout(() => { isWaiting = false; render(); }, 2000);
                }
            }
            render(); 
        }

        applyTheme(localStorage.getItem('theme') || colors[0]);
        render();
    </script>
</body>
</html>
